name: Deploy TV Event Streaming App
on:
  push:
    branches:
      - feature/*

# Require token generation access to authenticate with AWS OIDC
permissions:
  id-token: write
  contents: read

env:
  STACK_NAME: tv-event-streaming-gha
  REGION: eu-west-2

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - uses: aws-actions/setup-sam@v2
        with:
          use-installer: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Validate
        run: sam validate --lint

      - name: Build
        run: sam build --use-container

      - name: Check for failed deploy
        run: bash ./github/scripts/recover-failed-stack.sh

      - name: Read User Configuration
        id: users
        run: |
          # Read user configuration from config/users.json
          USER_NAMES=$(jq -r '.users[].email' config/users.json | tr '\n' ',' | sed 's/,$//')
          ADMIN_USER_NAMES=$(jq -r '.users[] | select(.type == "admin") | .email' config/users.json | tr '\n' ',' | sed 's/,$//')
          TEST_USERNAME=$(jq -r '.users[] | select(.type == "standard") | .email' config/users.json | head -1)
          ADMIN_USERNAME=$(jq -r '.users[] | select(.type == "admin") | .email' config/users.json | head -1)
          
          echo "user_names=$USER_NAMES" >> $GITHUB_OUTPUT
          echo "admin_user_names=${ADMIN_USER_NAMES:-}" >> $GITHUB_OUTPUT
          echo "test_username=$TEST_USERNAME" >> $GITHUB_OUTPUT
          echo "admin_username=$ADMIN_USERNAME" >> $GITHUB_OUTPUT
          
          echo "Configured users:"
          echo "  All users: $USER_NAMES"
          echo "  Admin users: ${ADMIN_USER_NAMES:-none}"
          echo "  Test user: $TEST_USERNAME"
          echo "  Admin user: $ADMIN_USERNAME"

      - name: Create or Update WatchMode API Key Secret
        env:
          WATCHMODE_API_KEY: ${{ secrets.WATCHMODE_API_KEY }}
        run: |
          SECRET_NAME="${STACK_NAME}/WatchModeApiKey"
          
          if [ -z "$WATCHMODE_API_KEY" ]; then
            echo "Error: WATCHMODE_API_KEY secret is not set in GitHub secrets"
            exit 1
          fi
          
          # Check if secret exists
          if aws secretsmanager describe-secret --secret-id "$SECRET_NAME" --region "$REGION" >/dev/null 2>&1; then
            echo "Updating existing secret: $SECRET_NAME"
            aws secretsmanager update-secret \
              --secret-id "$SECRET_NAME" \
              --secret-string "$WATCHMODE_API_KEY" \
              --region "$REGION"
          else
            echo "Creating new secret: $SECRET_NAME"
            aws secretsmanager create-secret \
              --name "$SECRET_NAME" \
              --description "WatchMode API key for stack $STACK_NAME" \
              --secret-string "$WATCHMODE_API_KEY" \
              --region "$REGION"
          fi
          
          # Get the secret ARN
          SECRET_ARN=$(aws secretsmanager describe-secret --secret-id "$SECRET_NAME" --region "$REGION" --query "ARN" --output text)
          echo "WatchModeApiKeySecretArn=$SECRET_ARN" >> $GITHUB_ENV
          echo "✅ Secret created/updated: $SECRET_ARN"

      - name: Deploy
        run: |
          sam deploy \
            --stack-name "$STACK_NAME" \
            --region "$REGION" \
            --capabilities CAPABILITY_NAMED_IAM CAPABILITY_AUTO_EXPAND \
            --no-fail-on-empty-changeset \
            --no-confirm-changeset \
            --parameter-overrides \
              "CreateDataStream=true" \
              "WatchModeApiKeySecretArn=${WatchModeApiKeySecretArn}" \
              "TestUserName=${{ steps.users.outputs.test_username }}" \
              "AdminUserName=${{ steps.users.outputs.admin_username }}"

      - name: Create Cognito Users
        run: |
          # Fetch UserPoolId from stack outputs
          USER_POOL_ID=$(aws cloudformation describe-stacks \
            --stack-name "$STACK_NAME" \
            --region "$REGION" \
            --query "Stacks[0].Outputs[?OutputKey=='UserPoolId'].OutputValue" \
            --output text)
          
          if [ -z "$USER_POOL_ID" ] || [ "$USER_POOL_ID" == "None" ]; then
            echo "Error: Could not retrieve UserPoolId from stack outputs"
            exit 1
          fi
          
          # Get usernames from config file
          USER_NAMES="${{ steps.users.outputs.user_names }}"
          ADMIN_USER_NAMES="${{ steps.users.outputs.admin_user_names }}"
          
          if [ -z "$USER_NAMES" ]; then
            echo "Error: Could not retrieve user names from configuration"
            exit 1
          fi
          
          # Invoke user creation script
          bash ./scripts/deploy/create-cognito-users.sh \
            "$USER_POOL_ID" \
            "$USER_NAMES" \
            "${ADMIN_USER_NAMES:-}" \
            "$STACK_NAME" \
            "$REGION"
          
          # Note: Passwords are automatically created by the Lambda function and stored in Secrets Manager
          # All scripts and tests retrieve passwords from Secrets Manager: ${STACK_NAME}/UserPasswords

      - name: Verify Passwords in Secrets Manager
        run: |
          SECRET_NAME="${STACK_NAME}/UserPasswords"
          TEST_USERNAME="${{ steps.users.outputs.test_username }}"
          ADMIN_USERNAME="${{ steps.users.outputs.admin_username }}"
          
          echo "Verifying passwords are stored in Secrets Manager..."
          
          # Wait a moment for eventual consistency
          sleep 2
          
          # Retry logic for secret retrieval
          MAX_RETRIES=5
          RETRY_COUNT=0
          SECRET_RETRIEVED=false
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if aws secretsmanager describe-secret --secret-id "$SECRET_NAME" --region "$REGION" >/dev/null 2>&1; then
              SECRET_VALUE=$(aws secretsmanager get-secret-value \
                --secret-id "$SECRET_NAME" \
                --region "$REGION" \
                --query "SecretString" \
                --output text 2>/dev/null || echo "")
              
              if [ -n "$SECRET_VALUE" ] && [ "$SECRET_VALUE" != "null" ] && [ "$SECRET_VALUE" != "None" ]; then
                # Verify we can extract passwords
                TEST_PWD=$(echo "$SECRET_VALUE" | jq -r ".[\"$TEST_USERNAME\"]" 2>/dev/null || echo "")
                ADMIN_PWD=$(echo "$SECRET_VALUE" | jq -r ".[\"$ADMIN_USERNAME\"]" 2>/dev/null || echo "")
                
                if [ -n "$TEST_PWD" ] && [ "$TEST_PWD" != "null" ] && [ -n "$ADMIN_PWD" ] && [ "$ADMIN_PWD" != "null" ]; then
                  echo "✅ Passwords verified in Secrets Manager"
                  echo "  Test user password length: ${#TEST_PWD} characters"
                  echo "  Admin user password length: ${#ADMIN_PWD} characters"
                  SECRET_RETRIEVED=true
                  break
                fi
              fi
            fi
            
            RETRY_COUNT=$((RETRY_COUNT + 1))
            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              echo "  Retry $RETRY_COUNT/$MAX_RETRIES: Waiting for secret to be available..."
              sleep 2
            fi
          done
          
          if [ "$SECRET_RETRIEVED" = "false" ]; then
            echo "⚠️  Warning: Could not verify passwords in Secrets Manager after $MAX_RETRIES attempts"
            echo "This may cause test failures, but deployment will continue"
          fi

      - name: Update Website Contents
        run: bash ./github/scripts/update-website-contents.sh ${STACK_NAME} ${REGION}

      - name: Clear Cloudfront cache
        run: bash ./github/scripts/clear-cloudfront-cache.sh ${STACK_NAME} ${REGION}

  ui-tests:
    runs-on: ubuntu-latest
    needs: deploy
    # Require token generation access to authenticate with AWS OIDC
    permissions:
      id-token: write
      contents: read
    env:
      STACK_NAME: tv-event-streaming-gha
      REGION: eu-west-2
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Test Dependencies
        working-directory: ./tests/ui
        run: npm ci

      - name: Install Playwright Browsers
        working-directory: ./tests/ui
        run: npx playwright install --with-deps

      - name: Configure Test Environment
        working-directory: ./tests/ui
        run: |
          # Fetch stack outputs to populate .env with URL and Client IDs
          # This script will also fetch passwords from Secrets Manager (where pipeline stores them)
          ./scripts/fetch-stack-outputs.sh "$STACK_NAME" "$REGION" "default"
          
          # Verify passwords were retrieved and are not empty
          TEST_PWD_LINE=$(grep "^TEST_USER_PASSWORD=" .env 2>/dev/null || echo "")
          ADMIN_PWD_LINE=$(grep "^ADMIN_USER_PASSWORD=" .env 2>/dev/null || echo "")
          
          if [ -z "$TEST_PWD_LINE" ] || [ -z "$ADMIN_PWD_LINE" ]; then
            echo "❌ ERROR: Passwords were not retrieved from Secrets Manager"
            echo "The pipeline should have created passwords and stored them in: ${STACK_NAME}/UserPasswords"
            echo ""
            echo "Current .env file contents (passwords redacted):"
            grep -E "^(TEST_USER|ADMIN_USER)" .env | sed 's/=.*/=***REDACTED***/' || echo "  No password lines found"
            exit 1
          fi
          
          # Extract password values (everything after =)
          TEST_PWD_VALUE=$(echo "$TEST_PWD_LINE" | cut -d'=' -f2-)
          ADMIN_PWD_VALUE=$(echo "$ADMIN_PWD_LINE" | cut -d'=' -f2-)
          
          if [ -z "$TEST_PWD_VALUE" ] || [ "$TEST_PWD_VALUE" = "" ]; then
            echo "❌ ERROR: TEST_USER_PASSWORD is empty in .env file"
            exit 1
          fi
          
          if [ -z "$ADMIN_PWD_VALUE" ] || [ "$ADMIN_PWD_VALUE" = "" ]; then
            echo "❌ ERROR: ADMIN_USER_PASSWORD is empty in .env file"
            exit 1
          fi
          
          echo "✅ Passwords retrieved from Secrets Manager"
          echo "  Test user password length: ${#TEST_PWD_VALUE} characters"
          echo "  Admin user password length: ${#ADMIN_PWD_VALUE} characters"
          
          # Verify passwords don't contain newlines or other problematic characters
          if echo "$TEST_PWD_VALUE" | grep -q $'\n'; then
            echo "⚠️  Warning: TEST_USER_PASSWORD contains newlines, which may cause issues"
          fi
          if echo "$ADMIN_PWD_VALUE" | grep -q $'\n'; then
            echo "⚠️  Warning: ADMIN_USER_PASSWORD contains newlines, which may cause issues"
          fi

      - name: Run UI Tests
        working-directory: ./tests/ui
        run: npm test

      - name: Upload Test Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: tests/ui/playwright-report/
          retention-days: 5