name: Deploy TV Event Streaming App
on:
  push:
    branches:
      - feature/*

# Require token generation access to authenticate with AWS OIDC
permissions:
  id-token: write
  contents: read

env:
  STACK_NAME: tv-event-streaming-gha
  REGION: eu-west-2

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - uses: aws-actions/setup-sam@v2
        with:
          use-installer: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Validate
        run: sam validate --lint

      - name: Build
        run: sam build --use-container

      - name: Check for failed deploy
        run: bash ./github/scripts/recover-failed-stack.sh

      - name: Deploy
        env:
          WATCHMODE_API_KEY: ${{ secrets.WATCHMODE_API_KEY }}
        run: |
          sam deploy \
            --stack-name "$STACK_NAME" \
            --region "$REGION" \
            --capabilities CAPABILITY_NAMED_IAM CAPABILITY_AUTO_EXPAND \
            --no-fail-on-empty-changeset \
            --no-confirm-changeset \
            --parameter-overrides "CreateDataStream=true" "WatchModeApiKey=${WATCHMODE_API_KEY}"

      - name: Set passwords for Cognito users
        env:
          TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}
          ADMIN_USER_PASSWORD: ${{ secrets.ADMIN_USER_PASSWORD }}
        run: |
          bash ./github/scripts/set-cognito-passwords.sh \
            ${TEST_USER_PASSWORD} \
            ${ADMIN_USER_PASSWORD} \
            ${STACK_NAME} \
            ${REGION}

      - name: Update Website Contents
        run: bash ./github/scripts/update-website-contents.sh ${STACK_NAME} ${REGION}

      - name: Clear Cloudfront cache
        run: bash ./github/scripts/clear-cloudfront-cache.sh ${STACK_NAME} ${REGION}

      # --- UI Testing Steps ---
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Test Dependencies
        working-directory: ./tests/ui
        run: npm ci

      - name: Install Playwright Browsers
        working-directory: ./tests/ui
        run: npx playwright install --with-deps

      - name: Configure Test Environment
        working-directory: ./tests/ui
        env:
          TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}
          ADMIN_USER_PASSWORD: ${{ secrets.ADMIN_USER_PASSWORD }}
        run: |
          # Fetch stack outputs to populate .env with URL and Client IDs
          ./scripts/fetch-stack-outputs.sh "$STACK_NAME" "$REGION" "default"
          
          # Explicitly append passwords (not in stack outputs)
          echo "TEST_USER_PASSWORD=$TEST_USER_PASSWORD" >> .env
          echo "ADMIN_USER_PASSWORD=$ADMIN_USER_PASSWORD" >> .env

      - name: Run UI Tests
        working-directory: ./tests/ui
        run: npm test

      - name: Upload Test Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: tests/ui/playwright-report/
          retention-days: 5